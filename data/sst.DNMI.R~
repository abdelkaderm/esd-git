as.field <- function(x,index,lon,lat,param,unit,alt=NA,location=NA,
                     cntr=NA,longname=NA,stid=NA,quality=NA,src=NA,url=NA,
                     reference=NA,info=NA,calendar='gregorian',greenwich=TRUE) {

  #print("lon"); print(lon); print("lat"); print(lat); print(param); print(unit)
  #print(c(length(lon),length(lat),length(index)))

  dyr <- as.numeric(format(index[2],'%Y')) - as.numeric(format(index[1],'%Y')) 
  dmo <- as.numeric(format(index[2],'%m')) - as.numeric(format(index[1],'%m')) 
  dda <- as.numeric(format(index[2],'%d')) - as.numeric(format(index[1],'%d'))
  timescale <- "annual"
  if (dmo>0)  timescale <- "month"
  if (dmo==3)  timescale <- "season"
  if (dda>0)  timescale <- "day"
  #print(timescale)
  
#create a zoo object z
  z <- zoo(x=x,order.by=index)
# Add attributes to z
  attr(z,"parameter") <- param
  attr(z,"longname") <- longname
  attr(z,"unit") <- units
  attr(z,"dimensions") <- c(length(lon),length(lat),length(index))
  attr(z,"longitude") <- lon
  attr(z,"latitude") <- lat
  attr(z,"greenwich") <- greenwich
  attr(z,"calendar") <- calendar 
  attr(z,"date") <- date()
  attr(z,"call") <- match.call()
  class(z) <- c("field",timescale,"zoo")
  #print(class(z))
  invisible(z)
}

eof2field <- function(eof,anomaly=FALSE) {
  U <- attr(eof,'pattern')
  d <- dim(U); dim(U) <- c(d[1]*d[2],d[3])
  W <- attr(eof,'eigenvalues')
  V <- coredata(eof)
  x <-U %*% diag(W) %*% t(V)
  if (!anomaly) x <- x + c(attr(eof,'mean'))
  x <- t(x)
  x <- as.field(x,index(eof),lon=attr(eof,'longitude'),lat=attr(eof,'latitude'),
                param=attr(eof,'parameter'),unit=attr(eof,'unit'),
                longname=attr(eof,'longname'),src=attr(eof,'src'),url=attr(eof,'url'),
                reference=attr(eof,'reference'),info=attr(eof,'info'),
                calendar=attr(eof,'calendar'),greenwich=attr(eof,'greenwich'))
  attr(eof,'history') <- c(attr(eof,'history'),'eof2field')
  attr(eof,'date-stamp') <- date()
  if (anomaly) attr(eof,'aspect') <- 'anomaly' else
               attr(eof,'aspect') <- 'original'
  attr(eof,'call') <- match.call()

  invisible(x)
}

load("eof.sst.DNMI.rda")
sst.DNMI <- eof2field(eof.sst.DNMI,anomaly=FALSE)
rm("eof.sst.DNMI")

# R.E. Benestad - replacement for old ds.one to downscale the CMIP 5 ensemble
# monthly mean temperature
# 30.01.2013
# ReinClim

require(esd)

 si <- list(R.version=sessionInfo()$R.version$version.string,
             esd.version=paste(sessionInfo()$otherPkgs$esd$Package,
                               sessionInfo()$otherPkgs$esd$Version,sep="_"),
             platform=sessionInfo()$platform)

path <- "CMIP5.monthly/rcp45/"
ncfiles <- list.files(path=path,pattern="tas_Amon_ens_rcp45",full.name=TRUE)
N <- length(ncfiles)
y <- station.metno("Oslo - Blinder")
# Need to fix the variable name:
attr(y,'variable') <- 't2m'
ym <- as.4seasons(y,FUN="mean")
ys <- as.4seasons(y,FUN="sd")
lon <- round( attr(y,'longitude') + c(-10,30) )
lat <- round( attr(y,'latitude') + c(-15,10) )
t2m <- t2m.ERA40(lon=lon,lat=lat)
T2M <- as.4seasons(t2m)

if ( (attr(y,'unit') == "deg C") | (attr(y,'unit') == "degree Celsius") )
      unit <- expression(degree*C) else
      unit <- attr(y,'unit')

par(bty="n")
plot.zoo(annual(ym),type="b",pch=19,main=attr(y,'location'),
         xlab="year",ylab=unit,
         sub=paste('Station: ',attr(y,'station_id'),'; coordinates: ',
           attr(y,'longitude'),'E/',attr(y,'latitude'),'N; ',attr(y,'altitude'),'m.a.s.l',sep=''),
         ylim=c(-2,8)+ range(coredata(annual(ym)),na.rm=TRUE),xlim=c(1900,2100))
rcp4.5 <- list(script="dscmip5.R",timestamp=data(),sessioninfo=si,
               station=y,domain=list(lon=lon,lat=lat),experiment="CMIP5",
               scenario="RCP4.5")

for (i in 1:N) {
  gcm <- retrieve.ncdf4(ncfile = ncfiles[i],lon=lon,lat=lat)
  # Need to fix the source attribute:
  attr(gcm,'source') <-  attr(gcm,'model_id')
  print(paste("i=",i,"GCM=",attr(gcm,'model_id')))

  # Need to fix the history attribute
  attr(gcm,'history') <- list(call="retrieve.ncdf4(ncfile = ncfiles[i],lon=lon,lat=lat)",
                              timestamp=date(),session=si)
  
  GCM <- as.4seasons(gcm)
  X <- combine(T2M,GCM)
  ds <- DS(y,X,biascorrect=TRUE)
 
  eval(parse(text=paste("rcp4.5$ds.gcm.",i," <- ds",sep=""))) 
  lines(annual(ds),lwd=1,col="grey")
  lines(annual(attr(ds,'appendix.1')),lwd=2,col="steelblue")
  lines(annual(ym),type="b",pch=19)
}

save(file=paste("dscmip5_",attr(y,'location'),"_",N,"_rcp4.5.rda",sep=""),rcp4.5)

  
           



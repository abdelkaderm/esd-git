# R.E. Benestad, met.no, Oslo, Norway 16.04.2002
# rasmus.benestad@met.no
#------------------------------------------------------------------------

# dat -> y; preds -> X

detrend<-function(x,...) UseMethod("detrend")

detrend.default <- function(x,...) {
}

detrend.station <- function(x,...) {
  year <- as.numeric( format(index(x), '%Y') ) 
  month <- as.numeric( format(index(x), '%m') )
  day <- as.numeric( format(index(x), '%d') )
  trendx <- data.frame(t=year + (month - 0.5)/12 + (day - 1)/365.25,
                       y=coredata(x))
  xt <- lm(y ~ t,data=trendx)
  #print(summary(xt))
  y <- zoo(xt$residual,order.by=index(x))
  #mostattributes(y) <- attributes(x)
  nattr <- softattr(x)
  for (i in 1:length(nattr))
    attr(y,nattr[i]) <- attr(x,nattr[i])
  attr(y,'original data') <-  x
  return(y)
}

detrend.eof <- function(x,...) {
  year <- as.numeric( format(index(x), '%Y') ) 
  month <- as.numeric( format(index(x), '%m') )
  day <- as.numeric( format(index(x), '%d') )
  class(x) -> cls
  
  #print("detrend.eof")
  d <- dim(x)
  Y <- x
  #print(dim(y))
  for (i in 1:d[2]) {
    trendx <- data.frame(t=year + (month - 0.5)/12 + (day - 1)/365.25,
                         y=coredata(x[,i]))
    xt <- lm(y ~ t,data=trendx)
    #z <- predict(xt); print(length(z))
    Y[,i] <- xt$residual
    #print(summary(Y[,i]))
  }
  #X <- zoo(Y,order.by=index(x))
  nattr <- softattr(x)
  for (i in 1:length(nattr))
    attr(y,nattr[i]) <- attr(x,nattr[i])
  #mostattributes(Y) <- attributes(x)
  attr(Y,'original data') <-  x
  
  #plot(x[,1]); lines(X[,1],col="red",lty=2)
  return(Y)
}

detrend.field <- function(x,...) {
  year <- as.numeric( format(index(x), '%Y') ) 
  month <- as.numeric( format(index(x), '%m') )
  day <- as.numeric( format(index(x), '%d') )
  class(x) -> cls
  
  #print("detrend.eof")
  d <- dim(x)
  Y <- x
  #print(dim(y))
  for (i in 1:d[2]) {
    trendx <- data.frame(t=year + (month - 0.5)/12 + (day - 1)/365.25,
                         y=coredata(x[,i]))
    xt <- lm(y ~ t,data=trendx)
    #z <- predict(xt); print(length(z))
    Y[,i] <- xt$residual
    #print(summary(Y[,i]))
  }
  #X <- zoo(Y,order.by=index(x))
  #mostattributes(Y) <- attributes(x)
  nattr <- softattr(x)
  for (i in 1:length(nattr))
    attr(y,nattr[i]) <- attr(x,nattr[i])
  attr(Y,'original data') <-  x
  
  #plot(x[,1]); lines(X[,1],col="red",lty=2)
  return(Y)
}
